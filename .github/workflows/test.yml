name: Test Formulas

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Tap this repository
        run: brew tap zdennis/bin .

      - name: List available formulas
        run: |
          echo "Available formulas:"
          ls -1 Formula/*.rb | sed 's|Formula/||; s|\.rb$||' | sort

      - name: Install all formulas
        run: |
          # Install zdennis-bin-all which depends on all other tools
          brew install zdennis/bin/zdennis-bin-all

      - name: Test all formulas
        run: |
          echo "=== Testing all formulas ==="
          failed=0
          for formula in Formula/*.rb; do
            name=$(basename "$formula" .rb)
            echo ""
            echo "Testing $name..."
            if brew test "zdennis/bin/$name"; then
              echo "✓ $name passed"
            else
              echo "✗ $name failed"
              failed=1
            fi
          done
          exit $failed

      - name: Show installed tools summary
        run: zdennis-bin-all
